<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>I AI Health</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #f7f8fc;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
  }

  header {
    background-color: #0b1b3d;
    color: white;
    padding: 10px 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 900px;
  }

  #chat-container {
    flex: 1;
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
  }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 24px 40px;
    display: flex;
    flex-direction: column;
    margin: 0 auto;
    scroll-behavior: smooth;
  }

  .msg {
    margin: 12px 0;
    font-size: 16px;
    line-height: 1.55;
    animation: fadeIn 0.3s ease-in;
  }

  .user {
    align-self: flex-end;
    color: #0b1b3d;
    font-weight: 500;
  }

  .ai {
    align-self: flex-start;
    color: #222;
    max-width: 90%;
  }

  .ai ol, .ai ul {
    margin: 4px 0 4px 20px;
    padding: 0;
  }

  .ai li {
    margin: 2px 0;
    line-height: 1.6;
  }

  .welcome {
    text-align: center;
    font-size: 15px;
    color: #333;
    margin-top: 10px;
    line-height: 1.4;
  }

  footer {
    background: #fff;
    border-top: 1px solid #ddd;
    padding: 10px;
    width: 100%;
    max-width: 900px;
    position: sticky;
    bottom: 0;
  }

  .chat-input-row {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #f3f4f6;
    border: 1px solid #ccc;
    border-radius: 25px;
    padding: 6px 10px;
  }

  .chat-input-row textarea {
    flex: 1;
    resize: none;
    overflow-y: hidden;
    border: none;
    background: transparent;
    padding: 6px 10px;
    font-size: 15px;
    outline: none;
    height: 28px;
    max-height: 90px;
  }

  #sendBtn {
    background-color: #0b1b3d;
    color: white;
    font-size: 16px;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
  }

  #sendBtn:hover {
    background-color: #1f3b80;
    transform: scale(1.05);
  }

  .side-buttons {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .side-buttons button {
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
  }

  #clearBtn {
    background-color: #f0f0f0;
    color: #333;
    border: 1px solid #ccc;
  }

  #clearBtn:hover {
    background-color: #e4e4e4;
  }

  #pdfBtn {
    background-color: #2e1a09;
    color: white;
  }

  #pdfBtn:hover {
    background-color: #462608;
  }

  select {
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 14px;
    background: #fff;
    border: none;
    margin-left: 10px;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>

<body>
  <header>
    <span>I AI Health</span>
    <div>
      <label for="patientSelect" style="font-weight:400; margin-right:6px;">Select Patient:</label>
      <select id="patientSelect">
        <option value="">-- Select Patient (optional) --</option>
      </select>
    </div>
  </header>

  <div id="chat-container">
    <div id="chat">
      <div class="welcome">
        <b>Welcome to I AI Health.</b><br>
        Ask any health-related question, or select a patient above to get patient-specific insights.
      </div>
    </div>

    <footer>
      <div class="chat-input-row">
        <textarea id="userInput" rows="1" placeholder="Ask any health question..."></textarea>
        <button id="sendBtn" title="Send">‚û§</button>
        <div class="side-buttons">
          <button id="clearBtn" title="Clear">üßπ</button>
          <button id="pdfBtn" title="Download PDF">üìÑ</button>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const API_URL = "https://qpzsuekcrorq457i3t7kvmovei0isgcv.lambda-url.us-west-2.on.aws";
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const pdfBtn = document.getElementById("pdfBtn");
    const patientSelect = document.getElementById("patientSelect");

    let currentPatient = "";

    function addMessage(role, text, isHTML = false) {
      const div = document.createElement("div");
      div.classList.add("msg", role === "ai" ? "ai" : "user");
      if (isHTML) div.innerHTML = text;
      else div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    async function loadPatients() {
      try {
        const res = await fetch(`${API_URL}/patients`);
        const data = await res.json();
        const patients = data.patients || [];
        if (patients.length) {
          for (const p of patients) {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.name;
            patientSelect.appendChild(opt);
          }
        }
      } catch {
        const opt = document.createElement("option");
        opt.textContent = "Error loading patients";
        patientSelect.appendChild(opt);
      }
    }

    patientSelect.addEventListener("change", e => {
      currentPatient = e.target.value;
      if (!currentPatient) {
        addMessage("ai", "Switched to general health Q&A mode.");
      } else {
        addMessage("ai", `Now answering based on patient: ${e.target.options[e.target.selectedIndex].text}`);
      }
    });

    async function sendMessage() {
      const question = input.value.trim();
      if (!question) return;
      addMessage("user", question);
      input.value = "";
      input.style.height = "24px";

      const loadingDiv = addMessage("ai", "...");
      loadingDiv.style.opacity = "0.5";

      try {
        const endpoint = currentPatient ? "/ask" : "/general";
        const body = currentPatient
          ? { question, tone: "patient", patientId: currentPatient }
          : { question, tone: "patient" };

        const res = await fetch(`${API_URL}${endpoint}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        loadingDiv.remove();

        let raw = data.answer || "No response from AI.";

        // Convert markdown-like formatting to HTML
        raw = raw.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

        // Create ordered lists
        raw = raw
          .replace(/(?:^|\n)(\d+)\.\s/g, (match, num) => `</li><li>${num}. `)
          .replace(/^<\/li>/, '<ol><li>')
          .concat("</li></ol>")
          .replace(/<\/ol><ol>/g, '');

        // Unordered bullets
        raw = raw.replace(/- /g, '<br>‚Ä¢ ');

        // Clean line breaks
        raw = raw.replace(/\n\s*\n/g, '<br>').replace(/\n/g, '<br>');

        const aiDiv = addMessage("ai", "", true);
        animateText(aiDiv, raw); // scroll while adding
      } catch {
        loadingDiv.remove();
        addMessage("ai", "‚ö†Ô∏è Error connecting to AI.");
      }
    }

    // Smooth typing animation + auto-scroll
    async function animateText(div, html) {
      let i = 0;
      const speed = 10;
      const plain = html.replace(/<[^>]+>/g, "");
      div.innerHTML = "";

      const interval = setInterval(() => {
        div.innerHTML = html.slice(0, i) + (i % 2 ? "|" : "");
        chat.scrollTop = chat.scrollHeight; // keep scrolling down
        i++;
        if (i >= html.length) {
          div.innerHTML = html;
          chat.scrollTop = chat.scrollHeight;
          clearInterval(interval);
        }
      }, speed);
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    clearBtn.addEventListener("click", () => {
      chat.innerHTML = `<div class="welcome"><b>Welcome to I AI Health.</b><br>Ask any health-related question, or select a patient above to get patient-specific insights.</div>`;
    });

    pdfBtn.addEventListener("click", async () => {
      const allText = Array.from(document.querySelectorAll(".msg"))
        .map(m => (m.classList.contains("user") ? "You: " : "AI: ") + m.textContent)
        .join("\n\n");

      try {
        const res = await fetch(`${API_URL}/pdf`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: allText })
        });

        const data = await res.json();
        if (data.file) {
          const byteChars = atob(data.file);
          const byteNumbers = Array.from(byteChars, c => c.charCodeAt(0));
          const blob = new Blob([new Uint8Array(byteNumbers)], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = data.filename || "I_AI_Report.pdf";
          link.click();
          URL.revokeObjectURL(url);
        }
      } catch {
        alert("Failed to generate PDF");
      }
    });

    input.addEventListener("input", () => {
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 90) + "px";
    });

    loadPatients();
  </script>
</body>
</html>

